!function(e){function n(r){if(t[r])return t[r].exports;var i=t[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){"use strict";function r(e){e?i():T.writeLog("APP_002","invalid server settings",k)}function i(){w.navClient=new s({username:k.navCoin.user,password:k.navCoin.pass,port:k.navCoin.port,host:k.navCoin.host}),w.subClient=new s({username:k.subChain.user,password:k.subChain.pass,port:k.subChain.port,host:k.subChain.host}),k.ssl?d.exists(k.ssl.key,function(e){d.exists(k.ssl.crt,function(n){if(!e||!n)return void T.writeLog("APP_003","unable to find user defined ssl certificate",k.ssl);var t={key:d.readFileSync(k.ssl.key),cert:d.readFileSync(k.ssl.crt),requestCert:!1,rejectUnauthorized:!1};S.use(u.json()),S.use(u.urlencoded({extended:!0})),a.createServer(t,S).listen(k.local.port,function(){L()})})}):c.createCertificate({days:1,selfSigned:!0},function(e,n){var t={key:n.serviceKey,cert:n.certificate,requestCert:!1,rejectUnauthorized:!1};S.use(u.json()),S.use(u.urlencoded({extended:!0})),a.createServer(t,S).listen(k.local.port,function(){L()})})}var s=t(1),o=t(2),a=t(3),c=t(4),u=t(5),d=t(6),l=t(7),g=t(8),p=t(9),v=t(31),m=t(36),f=t(17),y=t(19),h=t(21),b=t(10),T=t(13),A=t(15),C=l.get("GLOBAL"),k=!1;"INCOMING"===C.serverType&&(k=l.get("INCOMING")),"OUTGOING"===C.serverType&&(k=l.get("OUTGOING")),T.writeLog("SYS_001","Server Starting",{memes:["harambe","rustled jimmies"]},!0);var S=o(),w={};k?m.validateSettings({settings:k},r):T.writeLog("APP_001","invalid global server type",C.serverType);var L=function(){"INCOMING"===C.serverType?(p.init(),P()):"OUTGOING"===C.serverType&&(v.init(),P())},P=function(){S.get("/",function(e,n){g("dist/navtech.js",function(e,t){return e?void n.send(JSON.stringify({status:200,type:"FAILURE",message:"error generating md5 hash",serverType:C.serverType,error:e})):void n.send(JSON.stringify({status:200,type:"SUCCESS",message:"server is running!",serverType:C.serverType,anonhash:t}))})}),S.post("/api/test-decryption",function(e,n){return w.runtime={},w.runtime.req=e,w.runtime.res=n,e.body&&e.body.encrypted_data?void y.decryptData({encryptedData:w.runtime.req.body.encrypted_data},w.checkDecrypted):(T.writeLog("APP_004","failed to receive params",{body:e.body}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_004",message:"failed to receive params"})))}),w.checkDecrypted=function(e,n){return e&&n&&n.decrypted?void w.runtime.res.send(JSON.stringify({status:200,type:"SUCCESS",message:"decryption test successful"})):(T.writeLog("APP_005","unable to derypt the data",{success:e,data:n,body:w.runtime.req.body}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_005",message:"ERROR: unable to decrypt the data"})))},S.post("/api/get-addresses",function(e,n){return w.runtime={},w.runtime.req=e,w.runtime.res=n,w.runtime.req.body&&w.runtime.req.body.num_addresses&&w.runtime.req.body.type&&w.runtime.req.body.account?(w.runtime.accountToUse=A.account[w.runtime.req.body.account],w.runtime.accountToUse||w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_006A",message:"ERROR: invalid account",body:w.runtime.req.body})),"OUTGOING"===C.serverType?void w.checkIpAddress({allowedIps:k.remote},w.getAddresses):void w.getAddresses()):(T.writeLog("APP_006","failed to receive params",{body:e.body}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_006",message:"ERROR: invalid params",body:w.runtime.req.body})))}),w.getAddresses=function(){w.runtime.numAddresses=parseInt(w.runtime.req.body.num_addresses,10),"SUBCHAIN"===w.runtime.req.body.type?w.runtime.clientToUse=w.subClient:w.runtime.clientToUse=w.navClient,h.getRandomAccountAddresses({client:w.runtime.clientToUse,accountName:w.runtime.accountToUse,numAddresses:w.runtime.numAddresses},w.returnAddresses)},w.returnAddresses=function(e,n){return e&&n&&n.pickedAddresses?void w.runtime.res.send(JSON.stringify({status:200,type:"SUCCESS",data:{addresses:n.pickedAddresses}})):(T.writeLog("APP_008","failed to pick random addresses",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_008",message:"failed to pick random addresses"})))},S.get("/api/get-nav-balance",function(e,n){w.runtime={},w.runtime.req=e,w.runtime.res=n,w.navClient.getBalance().then(function(e){w.runtime.res.send(JSON.stringify({status:200,type:"SUCCESS",data:{nav_balance:e}}))}).catch(function(e){T.writeLog("APP_009","failed to get the NAV balance",{error:e}),w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_009",message:"failed to get the NAV balance"}))})}),w.checkIpAddress=function(e,n){for(var t=w.runtime.req.connection.remoteAddress||w.runtime.req.socket.remoteAddress,r=!1,i=0;i<e.allowedIps.length;i++)t!==e.allowedIps[i].ipAddress&&t!=="::ffff:"+e.allowedIps[i].ipAddress||(r=!0);r?n():(T.writeLog("APP_025","unauthorized access attempt",{remoteIpAddress:t,remote:e.allowedIps}),w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_025",message:"unauthorized access attempt"})))},S.post("/api/check-node",function(e,n){return w.runtime={},w.runtime.req=e,w.runtime.res=n,w.runtime.req.body&&w.runtime.req.body.num_addresses?(w.runtime.numAddresses=parseInt(w.runtime.req.body.num_addresses,10),"INCOMING"===C.serverType?C.maintenance?void w.checkIpAddress({allowedIps:C.allowedIps},w.checkNavBlocks):void w.checkNavBlocks():void w.checkIpAddress({allowedIps:k.remote},w.checkNavBlocks)):(T.writeLog("APP_026","failed to receive params",{body:e.body}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_026",message:"failed to receive params"})))}),w.checkNavBlocks=function(){f.checkBlockHeight({client:w.navClient,blockThreshold:A.blockThreshold.checking},w.navBlocksChecked)},w.navBlocksChecked=function(e,n){return e&&n?(w.runtime.navBalance=n.balance,void f.checkBlockHeight({client:w.subClient,blockThreshold:A.blockThreshold.checking},w.subBlocksChecked)):(T.writeLog("APP_027","navClient block check failed",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_027",message:"navClient block check failed"})))},w.subBlocksChecked=function(e,n){return e&&n?(w.runtime.subBalance=n.balance,void f.unlockWallet({settings:k,client:w.navClient,type:"navCoin"},w.unlockSubchain)):(T.writeLog("APP_028","subClient block check failed",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_028",message:"subClient block check failed"})))},w.unlockSubchain=function(e,n){return e?void f.unlockWallet({settings:k,client:w.subClient,type:"subChain"},w.getUnspent):(T.writeLog("APP_029","navClient failed to unlock",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_029",message:"navClient failed to unlock"})))},w.getUnspent=function(e,n){return e?"OUTGOING"===C.serverType?void b.getEncryptionKeys({},w.testKeyPair):void w.navClient.listUnspent().then(function(e){return e.length<1?void b.getEncryptionKeys({},w.testKeyPair):void f.filterUnspent({unspent:e,client:w.navClient,accountName:A.account[C.serverType]},w.processFiltered)}).catch(function(e){T.writeLog("APP_030A","failed to get unspent from the navClient",{error:e}),w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_030A",message:"failed to get unspent from the navClient"}))}):(T.writeLog("APP_030","subClient failed to unlock",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_030",message:"subClient failed to unlock"})))},w.processFiltered=function(e,n){if(!e)return T.writeLog("APP_030C","failed to filter the unspent",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_030C",message:"failed to filter the unspent"}));var t=0;if(n.currentPending&&n.currentPending.length>0){var r=!0,i=!1,s=void 0;try{for(var o,a=n.currentPending[Symbol.iterator]();!(r=(o=a.next()).done);r=!0){var c=o.value;c.confirmations>t&&(t=c.confirmations)}}catch(e){i=!0,s=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw s}}if(t>60)return T.writeLog("APP_030B","the queue is too long",{highestConf:t},!0),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_030B",message:"the queue is too long"}))}b.getEncryptionKeys({},w.testKeyPair)},w.testKeyPair=function(e,n){return e&&n&&n.privKeyFile&&n.pubKeyFile?void b.testKeyPair({pubKeyFile:n.pubKeyFile,privKeyFile:n.privKeyFile},w.testedKeypair):(T.writeLog("APP_031","failed to get the current keys",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_031",message:"failed to get the current keys"})))},w.testedKeypair=function(e,n){return e&&n&&n.publicKey?(w.runtime.publicKey=n.publicKey,void h.getRandomAccountAddresses({client:w.navClient,accountName:A.account[C.serverType],numAddresses:w.runtime.numAddresses},w.hasRandomAddresses)):(T.writeLog("APP_032","failed to encrypt with selected keypair",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_032",message:"failed to encrypt with selected keypair"})))},w.hasRandomAddresses=function(e,n){return e&&n&&n.pickedAddresses?(w.runtime.navAddresses=n.pickedAddresses,void w.getHash()):(T.writeLog("APP_033","failed to retrieve nav addresses",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_033",message:"failed to retrieve nav addresses"})))},w.hasRandomSubAddresses=function(e,n){return e&&n&&n.pickedAddresses?(w.runtime.subAddresses=n.pickedAddresses,void w.getHash()):(T.writeLog("APP_034","failed to retrieve subchain addresses",{success:e,data:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAIL",code:"APP_034",message:"failed to retrieve subchain addresses"})))},w.getHash=function(){g("dist/navtech.js",function(e,n){return e?(T.writeLog("APP_035A","error generating md5 hash",{err:e,hash:n}),void w.runtime.res.send(JSON.stringify({status:200,type:"FAILURE",message:"error generating md5 hash",serverType:C.serverType,error:e}))):void w.returnCheckedNode(n)})},w.returnCheckedNode=function(e){var n=k.local.host?k.local.host:k.local.ipAddress,t={nav_balance:w.runtime.navBalance,sub_balance:w.runtime.subBalance,public_key:w.runtime.publicKey,server_type:C.serverType,min_amount:k.minAmount,max_amount:k.maxAmount,transaction_fee:k.anonFeePercent,server:n,server_port:k.local.port?k.local.port:443,md5:e};t.nav_addresses=w.runtime.navAddresses,w.runtime.res.send(JSON.stringify({status:200,type:"SUCCESS",data:t}))},S.get("/api/status",function(e,n){if(w.runtime={},w.runtime.req=e,w.runtime.res=n,"INCOMING"===C.serverType){var t=new Date,r=t-p.runtime.cycleStart,i=k.scriptInterval-r;w.runtime.res.send(JSON.stringify({status:200,type:"SUCCESS",data:{processing:p.processing,paused:p.paused,nextCycleStart:Math.round(i/1e3)+" seconds"}}))}else if("OUTGOING"===C.serverType){var s=new Date,o=s-v.runtime.cycleStart,a=k.scriptInterval-o;w.runtime.res.send(JSON.stringify({status:200,type:"SUCCESS",data:{processing:v.processing,paused:v.paused,nextCycleStart:Math.round(a/1e3)+" seconds"}}))}})}},function(e,n){e.exports=require("bitcoin-core")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("https")},function(e,n){e.exports=require("pem")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("fs")},function(e,n){e.exports=require("config")},function(e,n){e.exports=require("md5-file")},function(e,n,t){"use strict";var r=t(1),i=t(7),s=t(10),o=t(13),a=t(16),c=t(18),u=t(22),d=t(24),l=t(26),g=t(27),p=t(28),v=t(30),m=i.get("INCOMING"),f={processing:!1,paused:!1,runtime:{}};f.init=function(){f.navClient=new r({username:m.navCoin.user,password:m.navCoin.pass,port:m.navCoin.port,host:m.navCoin.host}),f.subClient=new r({username:m.subChain.user,password:m.subChain.pass,port:m.subChain.port,host:m.subChain.host}),o.writeLog("INC_000","server starting"),s.findKeysToRemove({type:"private"},f.startProcessing),setInterval(function(){f.paused===!1?s.findKeysToRemove({type:"private"},f.startProcessing):o.writeLog("INC_001","processing paused",{paused:f.paused})},m.scriptInterval)},f.startProcessing=function(){return f.processing?void o.writeLog("INC_002","server still processing",{processing:f.processing}):(f.processing=!0,f.runtime={},f.runtime.cycleStart=new Date,void a.run({navClient:f.navClient,subClient:f.subClient,settings:m},f.preFlightComplete))},f.preFlightComplete=function(e,n){return e?(f.runtime.navBalance=n.navBalance,f.runtime.subBalance=n.subBalance,void c.run({navClient:f.navClient},f.holdingProcessed)):(o.writeLog("INC_003","preflight checks failed",{success:e,data:n},!0),void(f.processing=!1))},f.holdingProcessed=function(e,n){return e?void u.run({settings:m,navClient:f.navClient},f.outgoingSelected):(o.writeLog("INC_004","failed to process the holding account",{success:e,data:n},!0),void(f.processing=!1))},f.outgoingSelected=function(e,n){return e?n.returnAllToSenders?void d.run({navClient:f.navClient},f.allPendingReturned):(f.runtime.chosenOutgoing=n.chosenOutgoing,f.runtime.outgoingNavBalance=n.outgoingNavBalance,f.runtime.holdingEncrypted=n.holdingEncrypted,f.runtime.outgoingPubKey=n.outgoingPubKey,void l.run({navClient:f.navClient,outgoingNavBalance:n.outgoingNavBalance,subBalance:f.runtime.subBalance},f.currentBatchPrepared)):(o.writeLog("INC_005","failed to find outgoing server",{success:e,data:n},!0),void(f.processing=!1))},f.allPendingReturned=function(e,n){return console.log("STATUS: IncomingServer.allPendingReturned",e,n),e?(o.writeLog("INC_007","returned all pending to sender",{success:e,data:n},!0),void(f.processing=!1)):(o.writeLog("INC_006","failed to return all pending to sender",{success:e,data:n},!0),void(f.processing=!1))},f.currentBatchPrepared=function(e,n){return e&&n&&n.currentBatch?(f.runtime.currentBatch=n.currentBatch,void g.run({subClient:f.subClient,chosenOutgoing:f.runtime.chosenOutgoing,currentBatch:n.currentBatch},f.retrievedSubchainAddresses)):void(f.processing=!1)},f.retrievedSubchainAddresses=function(e,n){return e&&n&&n.subAddresses?void p.run({currentBatch:f.runtime.currentBatch,outgoingPubKey:f.runtime.outgoingPubKey,subClient:f.subClient,navClient:f.navClient,subAddresses:n.subAddresses,settings:m},f.transactionsProcessed):(o.writeLog("INC_009","failed to retrieve subchain addresses",{success:e,data:n},!0),void d.run({navClient:f.navClient},f.allPendingReturned))},f.transactionsProcessed=function(e,n){return e&&n?(f.runtime.successfulSubTransactions=n.successfulSubTransactions,f.runtime.transactionsToReturn=n.transactionsToReturn,f.runtime.transactionsToReturn&&f.runtime.transactionsToReturn.length>0?(o.writeLog("INC_011","failed to process some transactions",{success:e,data:n},!0),void d.fromList({navClient:f.navClient,transactionsToReturn:n.transactionsToReturn},f.failedTransactionsReturned)):void f.failedTransactionsReturned(!0)):(o.writeLog("INC_010","failed to process transactions",{success:e,data:n},!0),void d.run({navClient:f.navClient},f.allPendingReturned))},f.failedTransactionsReturned=function(e,n){e||o.writeLog("INC_012","failed to return failed transactions to sender",{success:e,data:n},!0),v.run({successfulSubTransactions:f.runtime.successfulSubTransactions,holdingEncrypted:f.runtime.holdingEncrypted,navClient:f.navClient},f.spentToHolding)},f.spentToHolding=function(e,n){e||(o.writeLog("INC_013","failed to spend successful to holding",{success:e,data:n},!0),f.paused=!0,f.processing=!1),f.processing=!1},e.exports=f},function(e,n,t){"use strict";var r=t(6),i=t(11),s=t(7),o=t(12),a=t(13),c=t(15),u=s.get("GLOBAL"),d={};d.testKeyPair=function(e,n){var t=["pubKeyFile","privKeyFile"];if(o.intersection(Object.keys(e),t).length!==t.length)return a.writeLog("ENC_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to EncryptionKeys.testKeyPair"});try{var s="NWMZ2atWCbUnVDKgmPHeTbGLmMUXZxZ3J3",c=i.createPublicKey(r.readFileSync(e.pubKeyFile)),u=c.encrypt(s,"utf8","base64",i.RSA_PKCS1_PADDING),d=i.createPrivateKey(r.readFileSync(e.privKeyFile)),l=d.decrypt(u,"base64","utf8",i.RSA_PKCS1_PADDING);if(l!==s)return a.writeLog("ENC_002","failed to decrypt",{decrypted:l,address:s}),void n(!1,{message:"failed to decrypt"});r.readFile(e.pubKeyFile,"utf-8",function(e,t){return e?(a.writeLog("ENC_003","failed to get public key contents",{error:e,fileData:t}),void n(!1,{message:e})):void n(!0,{publicKey:t})})}catch(e){a.writeLog("ENC_004","failed to encrypt",{error:e}),n(!1,{message:"failed to encrypt"})}},d.getEncryptionKeys=function(e,n){var t=new Date,i=d.getMidnight(t),s=c.keyFolders.private.path+i+c.keyFolders.private.suffix,o=c.keyFolders.public.path+i+c.keyFolders.public.suffix;r.exists(s,function(e){r.exists(o,function(t){return e&&t?void n(!0,{privKeyFile:s,pubKeyFile:o}):void d.generateKeys({privKeyFile:s,pubKeyFile:o},n)})})},d.generateKeys=function(e,n){var t=["pubKeyFile","privKeyFile"];if(o.intersection(Object.keys(e),t).length!==t.length)return a.writeLog("ENC_005","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to EncryptionKeys.generateKeys"});var s=c.encryptionStrength[u.serverType],d=new i.generatePrivateKey(s,65537),l=d.toPrivatePem().toString("ascii"),g=d.toPublicPem().toString("ascii");r.writeFile(e.privKeyFile,l,function(t){return t?(a.writeLog("ENC_005","unable to write private key to file system",{privKeyFile:e.privKeyFile,error:t}),void n(!1,{message:"unable to write private key to file system"})):void r.writeFile(e.pubKeyFile,g,function(t){return t?(a.writeLog("ENC_007","unable to write public key to file system",{pubKeyFile:e.pubKeyFile,error:t}),void n(!1)):void n(!0,{privKeyFile:e.privKeyFile,pubKeyFile:e.pubKeyFile})})})},d.findKeysToRemove=function(e,n){var t=["type"];return o.intersection(Object.keys(e),t).length!==t.length?(a.writeLog("ENC_008","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to EncryptionKeys.findKeysToRemove"})):void r.readdir(c.keyFolders[e.type].path,function(t,r){if(t)return a.writeLog("ENC_009","failed to open the keys directory",{error:t,files:r}),void n(!1,{message:"failed to open directory"});for(var i=new Date,s=d.getMidnight(i),o=[],u=0;u<r.length;u++){var l=new Date(parseInt(r[u].split("_")[0],10)),g=d.getMidnight(l),p=s-g;p>c.keyPeriod&&o.push(r[u])}o.length>0?d.removeKeys({forRemoval:o,type:e.type},n):"private"===e.type?d.findKeysToRemove({type:"public"},n):n(!0,{message:"nothing to remove"})})},d.removeKeys=function(e,n){0===e.forRemoval.length?"private"===e.type?d.findKeysToRemove({type:"public"},n):n(!0,{message:"all keys removed"}):r.exists(c.keyFolders[e.type].path+e.forRemoval[0],function(t){t?r.unlink(c.keyFolders[e.type].path+e.forRemoval[0],function(t){t&&a.writeLog("ENC_010","failed to remove the key",{error:t,key:e.forRemoval}),d.removeKeys({forRemoval:e.forRemoval.slice(1),type:e.type},n)}):d.removeKeys({forRemoval:e.forRemoval.slice(1),type:e.type},n)})},d.getMidnight=function(e){return parseInt(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),10)},e.exports=d},function(e,n){e.exports=require("ursa")},function(e,n){e.exports=require("lodash")},function(e,n,t){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=t(14),s=t(7),o=s.get("GLOBAL"),a=!1;"INCOMING"===o.serverType&&(a=s.get("INCOMING")),"OUTGOING"===o.serverType&&(a=s.get("OUTGOING"));var c=encodeURIComponent(a.smtp.user)+":"+encodeURIComponent(a.smtp.pass),u={};u.transporter=i.createTransport("smtps://"+c+"@"+a.smtp.server),u.writeLog=function(e,n,t,i){i&&u.sendMail(e,n,t);var s=new Date,o="\r\n";o+="Date: "+s+"\r\n",o+="Error Code: "+e+"\r\n",o+="Error Message: "+n+"\r\n";for(var a in t)if(t.hasOwnProperty(a)){var c=t[a];"object"===r(t[a])&&(c=JSON.stringify(t[a])),o+=a+": "+c+"\r\n"}o+="\r\n-----------------------------------------------------------\r\n",console.log(o)},u.sendMail=function(e,n,t){var r={from:'"Navtech System" <'+a.smtp.user+">",to:a.notificationEmail,subject:"Navtech System Message - "+a.local.ipAddress+" ("+o.serverType+") "+e,text:e+" - "+n,attachments:[{filename:"data.json",content:JSON.stringify(t)}]};u.transporter.sendMail(r,function(e,n){return e?console.log("nodemail error",e):console.log("nodemail success: "+n.response)})},e.exports=u},function(e,n){e.exports=require("nodemailer")},function(e,n){e.exports={keyFolders:{private:{path:"./keys/private/",suffix:"_private.pem"},public:{path:"./keys/public/",suffix:"_public.pub"}},keyPeriod:6048e5,minKeyStamp:14647392e5,account:{INCOMING:"incomingAccount",OUTGOING:"outgoingAccount",HOLDING:"holdingAccount"},maxAddresses:250,maxHolding:100,minNavTransactions:3,maxNavTransactions:8,txFee:.001,maxEncryptionAttempts:10,encryptionStrength:{INCOMING:2048,OUTGOING:1024},encryptionOutput:{INCOMING:344,OUTGOING:172},subCoinsPerTx:10,subChainTxFee:.001,minConfs:1,blockThreshold:{checking:5,processing:3}}},function(e,n,t){"use strict";var r=t(12),i=t(15),s=t(13),o=t(17),a={};a.run=function(e,n){var t=["navClient","subClient","settings"];return r.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("PRE_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to Preflight.checkNavBlocks"})):(a.runtime={callback:n,navClient:e.navClient,subClient:e.subClient,settings:e.settings},void o.checkBlockHeight({client:a.runtime.navClient,blockThreshold:i.blockThreshold.processing},a.navBlocksChecked))},a.navBlocksChecked=function(e,n){return e&&n?(a.runtime.navBalance=n.balance,void a.runtime.navClient.setTxFee(parseFloat(i.txFee)).then(function(){o.checkBlockHeight({client:a.runtime.subClient,blockThreshold:i.blockThreshold.processing},a.subBlocksChecked)}).catch(function(e){s.writeLog("PRE_003","failed to set NAV tx fee",{err:e}),a.runtime.callback(!1,{message:"failed to set NAV tx fee"})})):(s.writeLog("PRE_002","navClient block check failed",{status:e,data:n}),void a.runtime.callback(!1,{message:"navClient block check failed"}))},a.subBlocksChecked=function(e,n){return e&&n?(a.runtime.subBalance=n.balance,void o.unlockWallet({settings:a.runtime.settings,client:a.runtime.navClient,type:"navCoin"},a.navClientUnlocked)):(s.writeLog("PRE_004","subClient block check failed",{status:e,data:n}),void a.runtime.callback(!1,{message:"subClient block check failed"}))},a.navClientUnlocked=function(e,n){return e?void o.unlockWallet({settings:a.runtime.settings,client:a.runtime.subClient,type:"subChain"},a.subClientUnlocked):(s.writeLog("PRE_005","navClient failed to unlock",{status:e,data:n}),void a.runtime.callback(!1,{message:"navClient failed to unlock"}))},a.subClientUnlocked=function(e,n){return e?void a.runtime.subClient.setTxFee(parseFloat(i.subChainTxFee)).then(function(){a.runtime.callback(!0,{navBalance:a.runtime.navBalance,subBalance:a.runtime.subBalance})}).catch(function(e){s.writeLog("PRE_003","failed to set SUB tx fee",{err:e}),a.runtime.callback(!1,{message:"failed to set SUB tx fee"})}):(s.writeLog("PRE_006","subClient failed to unlock",{status:e,data:n}),void a.runtime.callback(!1,{message:"subClient failed to unlock"}))},e.exports=a},function(e,n,t){"use strict";var r=t(7),i=t(12),s=t(13),o=r.get("GLOBAL"),a={};a.unlockWallet=function(e,n){var t=["settings","client","type"];if(i.intersection(Object.keys(e),t).length!==t.length)return s.writeLog("NAV_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to NavCoin.unlockWallet"});if(o.encryptedWallet===!1)return void n(!0);var r=e.settings.scriptInterval/1e3;e.client.walletPassphrase(e.settings[e.type].walletPassphrase,r).then(function(){n(!0)}).catch(function(t){switch(t.code){case-17:n(!0);break;default:return n(!1,{message:"failed to unlock"}),void s.writeLog("NAV_002","failed to unlock "+e.type+" wallet",{error:t})}})},a.lockWallet=function(e,n){var t=["type","client"];return i.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("NAV_003","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to NavCoin.lockWallet"})):void e.client.walletLock().then(function(){s.writeLog("NAV_004","locked the "+e.type+" wallet",e),a.unlockWallet(e,n)}).catch(function(t){n(!1,{message:"failed to lock"}),s.writeLog("NAV_005","failed to lock "+e.type+" wallet",{error:t})})},a.filterUnspent=function(e,n){var t=["unspent","client","accountName"];if(i.intersection(Object.keys(e),t).length!==t.length)return s.writeLog("NAV_006","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to NavCoin.filterUnspent"});try{e.client.getAddressesByAccount(e.accountName).then(function(t){var r=!1,i=[],s=!0,o=!1,a=void 0;try{for(var c,u=e.unspent[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var d=c.value;t.indexOf(d.address)!==-1&&(r=!0,i.push(d))}}catch(e){o=!0,a=e}finally{try{!s&&u.return&&u.return()}finally{if(o)throw a}}return r?void n(!0,{currentPending:i}):void n(!0)}).catch(function(t){s.writeLog("NAV_007","failed to get address by account",{error:t,options:e}),n(!1)})}catch(n){s.writeLog("NAV_008","failed to filter",{error:n,options:e})}},a.checkBlockHeight=function(e,n){var t=["client","blockThreshold"];return i.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("NAV_009","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to NavCoin.checkBlockHeight"})):void e.client.getInfo().then(function(t){e.client.getBlockCount().then(function(r){return parseInt(r,10)-e.blockThreshold>parseInt(t.blocks,10)?(s.writeLog("NAV_010","client is not synced with the latest blocks",{walletInfo:t,blockCount:r}),void n(!1,{message:"client is not synced with the latest blocks"})):void n(!0,{balance:t.balance})}).catch(function(t){s.writeLog("NAV_011","failed to get block count",{error:t,options:e}),n(!1,{message:"failed to get block count"})})}).catch(function(t){s.writeLog("NAV_012","failed to get info",{error:t,options:e}),n(!1,{message:"failed to get info"})})},a.validateAddresses=function(e,n){var t=["client","addresses"];return i.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("NAV_013","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to NavCoin.validateAddresses"})):0===e.addresses.length?void n(!0):void e.client.validateAddress(e.addresses[0]).then(function(t){return t.isvalid!==!0?(s.writeLog("NAV_014","provided address is invalid",{address:e.addresses[0]}),void n(!1,{message:"provided address is invalid"})):void a.validateAddresses({addresses:e.addresses.slice(1),client:e.client},n)}).catch(function(t){s.writeLog("NAV_015","failed to validate address",{error:t,options:e}),n(!1,{message:"failed to validate address"})})},e.exports=a},function(e,n,t){"use strict";var r=t(12),i=t(15),s=t(13),o=t(17),a=t(19),c=t(20),u=t(21),d={};d.run=function(e,n){var t=["navClient"];return r.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("RFL_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to RefillOutgoing.checkHoldingAccount"})):(d.runtime={callback:n,navClient:e.navClient},void d.getUnspent())},d.getUnspent=function(){d.runtime.navClient.listUnspent().then(function(e){return e.length<1?(s.writeLog("RFL_002","no unspent in holding account",{unspent:e}),void d.runtime.callback(!0,{message:"no unspent in holding account"})):void o.filterUnspent({unspent:e,client:d.runtime.navClient,accountName:i.account.HOLDING},d.holdingFiltered)}).catch(function(e){s.writeLog("RFL_003","failed to list unspent",{error:e}),d.runtime.callback(!1,{message:"failed to list unspent"})})},d.holdingFiltered=function(e,n){return!e||!n||!n.currentPending||n.currentPending.length<1?void d.runtime.callback(!0,{message:"no pending to clear from account"}):(d.runtime.currentHolding=n.currentPending,void d.processHolding())},d.processHolding=function(){return d.runtime.currentHolding.length<1?(s.writeLog("RFL_005","all holding processed",{currentHolding:d.runtime.currentHolding}),void d.runtime.callback(!0,{message:"all holding processed"})):void d.checkIfHoldingIsSpendable()},d.checkIfHoldingIsSpendable=function(){return d.runtime.currentHolding[0].confirmations>i.minConfs?void a.getEncrypted({transaction:d.runtime.currentHolding[0],client:d.runtime.navClient},d.holdingDecrypted):(s.writeLog("RFL_006","holding account transaction not spendable",{currentHolding:d.runtime.currentHolding}),d.runtime.currentHolding.splice(0,1),void d.processHolding())},d.holdingDecrypted=function(e,n){if(!(e&&n&&n.decrypted&&n.transaction))return s.writeLog("RFL_007","failed to decrypt holding transaction data",{success:e,data:n}),d.runtime.currentHolding.splice(0,1),void d.processHolding();d.runtime.holdingTransaction=n.transaction;var t=JSON.parse(n.decrypted);if(t.constructor!==Array)return s.writeLog("RFL_007A","decrypted data not an array of addresses",{currentHolding:d.runtime.currentHolding}),d.runtime.currentHolding.splice(0,1),void d.processHolding();for(var r=Math.ceil(Math.random()*(t.length-(i.minNavTransactions-1)))+(i.minNavTransactions-1),o=[];o.length<r;){var a=Math.floor(Math.random()*t.length);o.push(t[a]),t.splice(a,1)}u.incoming({totalToSend:n.transaction.amount,addresses:o},d.checkRandomTransactions)},d.checkRandomTransactions=function(e,n){return!e||!n||!n.transactions||n.transactions.length<1?(s.writeLog("RFL_008","failed to randomize transactions",{success:e,data:n}),d.runtime.currentHolding.splice(0,1),void d.processHolding()):void d.sendRawRefillTransaction(n.transactions)},d.sendRawRefillTransaction=function(e){var n=[{txid:d.runtime.holdingTransaction.txid,vout:parseInt(d.runtime.holdingTransaction.vout,10)}];c.createRaw({outgoingTransactions:e,spentTransactions:n,client:d.runtime.navClient},d.refillSent)},d.refillSent=function(e,n){e&&n&&n.rawOutcome||s.writeLog("RFL_009","failed to send raw refill transaction",{holdingTxid:d.runtime.holdingTransaction.txid,holdingTransaction:d.runtime.holdingTransaction},!0),d.runtime.currentHolding.splice(0,1),d.processHolding()},e.exports=d},function(e,n,t){"use strict";var r=t(6),i=t(11),s=t(7),o=t(12),a=t(13),c=t(15),u=s.get("GLOBAL"),d={};d.getEncrypted=function(e,n){var t=["transaction","client"];return o.intersection(Object.keys(e),t).length!==t.length?(a.writeLog("ECD_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to EncryptedData.getEncrypted"})):(d.runtime={callback:n,transaction:e.transaction,client:e.client},void e.client.getTransaction(e.transaction.txid).then(function(t){var r="INCOMING"===u.serverType?t["anon-destination"]:t["tx-comment"];d.decryptData({encryptedData:r,transaction:e.transaction},n)}).catch(function(t){a.writeLog("ECD_002","failed to get transation",{transaction:e.transaction,error:t}),n(!1,{message:"failed to get transation"})}))},d.decryptData=function(e,n){var t=["encryptedData"];return o.intersection(Object.keys(e),t).length!==t.length?(a.writeLog("ECD_003","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to EncryptedData.decryptData"})):(d.runtime={callback:n,transaction:e.transaction,encryptedData:e.encryptedData},void r.readdir(c.keyFolders.private.path,function(t,s){if(t)return n(!1,{message:"failed to read the keyfolder"}),void a.writeLog("ECD_010","failed to read the keyfolder",{error:t,transaction:e.transasction});for(var o=!1,d=void 0,l=0;l<s.length;l++)if(!o)try{var g=c.keyFolders.private.path+s[l],p=i.createPrivateKey(r.readFileSync(g)),v=p.decrypt(e.encryptedData,"base64","utf8",i.RSA_PKCS1_PADDING);o=!0,d="INCOMING"===u.serverType?v:JSON.parse(v)}catch(e){}return o&&d?void n(!0,{decrypted:d,transaction:e.transaction}):(a.writeLog("ECD_011","unable to decrypt",{decrypted:d,
successfulDecryption:o,transaction:e.transasction}),void n(!1,{message:"unable to decrypt"}))}))},e.exports=d},function(e,n,t){"use strict";var r=t(7),i=t(12),s=t(13),o=t(17),a=r.get("GLOBAL"),c=!1;"INCOMING"===a.serverType&&(c=r.get("INCOMING")),"OUTGOING"===a.serverType&&(c=r.get("OUTGOING"));var u={};u.createRaw=function(e,n){var t=["spentTransactions","outgoingTransactions","client"];return i.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("RAW_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to SelectOutgoing.run"})):(u.runtime={},void(e.encrypted?e.client.createRawTransaction(e.spentTransactions,e.outgoingTransactions,e.encrypted).then(function(t){u.signRaw({client:e.client,rawTrans:t},n)}).catch(function(t){s.writeLog("RAW_002","unable to create raw transaction",{spentTransactions:e.spentTransactions,outgoingTransactions:e.outgoingTransactions,encrypted:e.encrypted,error:t}),n(!1,{error:t})}):e.client.createRawTransaction(e.spentTransactions,e.outgoingTransactions).then(function(t){u.signRaw({client:e.client,rawTrans:t},n)}).catch(function(t){s.writeLog("RAW_003","unable to create raw transaction",{spentTransactions:e.spentTransactions,outgoingTransactions:e.outgoingTransactions,error:t}),n(!1,{error:t})})))},u.signRaw=function(e,n){e.client.signRawTransaction(e.rawTrans).then(function(t){u.sendRaw({client:e.client,signedRaw:t},n)}).catch(function(t){if(t.code===-13&&!e.triedToUnlock){u.runtime.options=e,u.runtime.callback=n;var r=e.client.port===c.navCoin.port?"navCoin":"subChain";return void o.unlockWallet({settings:c,client:e.client,type:r},u.walletUnlocked)}s.writeLog("RAW_004","unable to sign raw transaction",{rawTrans:e.rawTrans,error:t}),n(!1,{error:t})})},u.walletUnlocked=function(e,n){if(!e)return s.writeLog("RAW_006","unable to unlock wallet",{success:e,data:n}),void u.runtime.callback(!1,n);var t={client:u.runtime.options.client,rawTrans:u.runtime.options.rawTrans,triedToUnlock:!0};u.signRaw(t,u.runtime.callback)},u.sendRaw=function(e,n){e.client.sendRawTransaction(e.signedRaw.hex).then(function(e){n(!0,{rawOutcome:e})}).catch(function(t){s.writeLog("RAW_005","unable to send raw transaction",{signedRaw:e.signedRaw,error:t}),n(!1,{error:t})})},e.exports=u},function(e,n,t){"use strict";var r=t(12),i=t(13),s=t(15),o={};o.incoming=function(e,n){var t=["totalToSend","addresses"];return r.intersection(Object.keys(e),t).length!==t.length?(i.writeLog("RND_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to RandomizeTransactions.incoming"})):(o.runtime={callback:n,totalToSend:e.totalToSend,addresses:e.addresses,transactions:{}},void o.randomizeIncoming())},o.randomizeIncoming=function(){for(var e=1e8,n=o.runtime.totalToSend*e,t=s.txFee*e,r=t*o.runtime.addresses.length,i=n-r,a=0,c=i/o.runtime.addresses.length,u=Math.floor(1.5*c*e),d=Math.floor(.5*c*e),l=0;l<o.runtime.addresses.length;l++)if(a<i){var g=Math.random()*(u-d)+d,p=Math.round(g/e);if(p>i-a||l===o.runtime.addresses.length-1){var v=i-a;o.runtime.transactions[o.runtime.addresses[l]]=v/e,a+=v}else o.runtime.transactions[o.runtime.addresses[l]]=p/e,a+=p}o.runtime.callback(!0,{transactions:o.runtime.transactions})},o.outgoing=function(e,n){var t=["transaction","address","amount"];return r.intersection(Object.keys(e),t).length!==t.length?(i.writeLog("RND_002","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to RandomizeTransactions.outgoing"})):(o.runtime={callback:n,transaction:e.transaction,address:e.address,amount:e.amount,transactions:[]},void o.randomizeOutgoing())},o.randomizeOutgoing=function(){for(var e=Math.ceil(Math.random()*(s.maxNavTransactions-s.minNavTransactions))+s.minNavTransactions,n=o.runtime.amount,t=1e8,r=n*t,i=0,a=r/e,c=Math.floor(1.5*a*t),u=Math.floor(.5*a*t),d=0;d<e;d++)if(i<r){var l=Math.random()*(c-u)+u,g=Math.round(l/t);if(g>r-i||d===e-1){var p=Math.floor(r-i);o.runtime.transactions.push(p/t),i+=p}else o.runtime.transactions.push(g/t),i+=g}o.runtime.callback(!0,{partialTransactions:o.runtime.transactions})},o.getRandomAccountAddresses=function(e,n){var t=["client","accountName","numAddresses"];return r.intersection(Object.keys(e),t).length!==t.length?(i.writeLog("RND_003","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to RandomizeTransactions.getRandomAccountAddresses"})):void e.client.getAddressesByAccount(e.accountName).then(function(t){o.chooseRandomAddresses({accountName:e.accountName,numAddresses:e.numAddresses,addresses:t},n)}).catch(function(t){i.writeLog("RND_004","get account address failed",{options:e,error:t}),n(!1,{message:"get account address failed"})})},o.chooseRandomAddresses=function(e,n){var t=["addresses","accountName","numAddresses"];if(r.intersection(Object.keys(e),t).length!==t.length)return i.writeLog("RND_005","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to RandomizeTransactions.chooseRandomAddresses"});for(var s=[],o=0;s.length<e.numAddresses&&o<1e4;){var a=Math.floor(Math.random()*e.addresses.length);e.addresses[a]&&(s.push(e.addresses[a]),e.addresses.splice(a,1)),o++}return s.length!==e.numAddresses?(i.writeLog("RND_006","picked addresses did not equal the number requested",{pickedAddresses:s.length,numAddresses:e.numAddresses,counter:o}),void n(!1)):void n(!0,{pickedAddresses:s})},e.exports=o},function(e,n,t){"use strict";var r=t(12),i=t(23),s=t(11),o=t(6),a=t(15),c=t(13),u=t(17),d=t(10),l={};l.run=function(e,n){var t=["settings","navClient"];return r.intersection(Object.keys(e),t).length!==t.length?(c.writeLog("SEL_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to SelectOutgoing.run"})):!e.settings.remote||e.settings.remote.length<1?(c.writeLog("SEL_002","no remote servers detected",{remoteCluster:e.settings.remote}),void n(!1,{message:"no remote servers detected"})):(l.runtime={callback:n,remoteCluster:JSON.parse(JSON.stringify(e.settings.remote)),settings:e.settings,navClient:e.navClient},void l.pickServer())},l.pickServer=function(){if(l.runtime.remoteCluster.length<1)return c.writeLog("SEL_003","no valid outgoing servers found"),void l.runtime.callback(!1,{returnAllToSenders:!0});var e=Math.floor(Math.random()*l.runtime.remoteCluster.length);l.runtime.chosenOutgoingIndex=e,l.runtime.chosenOutgoing=l.runtime.remoteCluster[e],l.testOutgoing(l.runtime.remoteCluster[e])},l.testOutgoing=function(e){var n=e.port?e.ipAddress+":"+e.port:e.ipAddress;l.runtime.outgoingAddress=n;var t={uri:"https://"+n+"/api/check-node",method:"POST",timeout:6e4,rejectUnauthorized:!1,requestCert:!0,agent:!1,form:{server_type:"OUTGOING",num_addresses:6}};i(t,l.gotServerResponse)},l.gotServerResponse=function(e,n,t){return e?(c.writeLog("SEL_004","failed to query outgoing server",{body:t,outgoingAddress:l.runtime.outgoingAddress,error:e}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),void l.pickServer()):void l.checkOutgoingCanTransact(t,l.runtime.outgoingAddress)},l.checkOutgoingCanTransact=function(e,n){try{var t=JSON.parse(e);if("SUCCESS"!==t.type)return c.writeLog("SEL_005","outgoing server returned failure",{body:t,outgoingAddress:n}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),void l.pickServer();if(!(t.data&&t.data.nav_addresses&&t.data.nav_balance&&t.data.public_key))return c.writeLog("SEL_006","outgoing server returned incorrect params",{body:t,outgoingAddress:n}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),void l.pickServer();if(l.runtime.outgoingServerData=t.data,l.runtime.outgoingNavBalance=t.data.nav_balance,"OUTGOING"!==l.runtime.outgoingServerData.server_type)return c.writeLog("SEL_007","outgoing server is of the wrong type",{body:l.runtime.outgoingServerData}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),void l.pickServer();var r={a:"NWMZ2atWCbUnVDKgmPHeTbGLmMUXZxZ3J3",n:"9999.99999999",s:l.runtime.settings.secret};l.checkPublicKey(r)}catch(t){return c.writeLog("SEL_005A","outgoing server returned non json response",{body:e,outgoingAddress:n}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),void l.pickServer()}},l.checkPublicKey=function(e){try{l.runtime.outgoingPubKey=s.createPublicKey(l.runtime.outgoingServerData.public_key);var n=l.runtime.outgoingPubKey.encrypt(JSON.stringify(e),"utf8","base64",s.RSA_PKCS1_PADDING);if(!n||n.length!==a.encryptionOutput.OUTGOING)return c.writeLog("SEL_008","failed to encrypt test data",{encrypted:n}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),void l.pickServer();l.hasNavAddresses()}catch(e){c.writeLog("SEL_009","bad public key provided by outgoing server",{error:e,body:l.runtime.outgoingServerData}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),l.pickServer()}},l.hasNavAddresses=function(){return l.runtime.outgoingServerData.nav_addresses.length<1?(c.writeLog("SEL_010","outgoing server did not provide at least 1 address",{body:l.runtime.outgoingServerData}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),void l.pickServer()):void u.validateAddresses({client:l.runtime.navClient,addresses:l.runtime.outgoingServerData.nav_addresses},l.navAddressesValid)},l.navAddressesValid=function(e){return e?void d.getEncryptionKeys({},l.encryptOutgoingAddresses):(c.writeLog("SEL_011","invalid nav addresses sent from the outgoing server",{addressesValid:e}),l.runtime.remoteCluster.splice(l.runtime.chosenOutgoingIndex,1),void l.pickServer())},l.encryptOutgoingAddresses=function(e,n){e&&n&&n.privKeyFile&&n.pubKeyFile||(c.writeLog("SEL_012","failed to get the current keys",{success:e,data:n}),l.runtime.callback(!1,{returnAllToSenders:!0}));try{var t=s.createPublicKey(o.readFileSync(n.pubKeyFile)),r=t.encrypt(JSON.stringify(l.runtime.outgoingServerData.nav_addresses),"utf8","base64",s.RSA_PKCS1_PADDING),i=s.createPrivateKey(o.readFileSync(n.privKeyFile)),a=i.decrypt(r,"base64","utf8",s.RSA_PKCS1_PADDING);return a!==JSON.stringify(l.runtime.outgoingServerData.nav_addresses)?(c.writeLog("SEL_013","failed to encrypt with local key",{success:e,data:n,encrypted:r,decrypted:a}),void l.runtime.callback(!1,{returnAllToSenders:!0})):void l.runtime.callback(!0,{chosenOutgoing:l.runtime.chosenOutgoing,outgoingNavBalance:l.runtime.outgoingNavBalance,outgoingPubKey:l.runtime.outgoingPubKey,holdingEncrypted:r,returnAllToSenders:!1})}catch(t){c.writeLog("SEL_014","failed to use local key",{success:e,data:n,error:t,encrypting:l.runtime.outgoingServerData.nav_addresses}),l.runtime.callback(!1,{returnAllToSenders:!0})}},e.exports=l},function(e,n){e.exports=require("request")},function(e,n,t){"use strict";var r=t(12),i=t(7),s=i.get("GLOBAL"),o=t(13),a=t(17),c=t(15),u=t(25),d={};d.run=function(e,n){var t=["navClient"];return r.intersection(Object.keys(e),t).length!==t.length?(o.writeLog("RATS_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to ReturnAllToSenders.run"})):(d.runtime={callback:n,navClient:e.navClient},void d.getUnspent())},d.fromList=function(e,n){var t=["navClient","transactionsToReturn"];r.intersection(Object.keys(e),t).length!==t.length&&(o.writeLog("RATS_001A","invalid options",{options:e,required:t}),n(!1,{message:"invalid options provided to ReturnAllToSenders.fromList"})),d.runtime={callback:n,navClient:e.navClient,transactionsToReturn:e.transactionsToReturn},d.returnToSender()},d.getUnspent=function(){d.runtime.navClient.listUnspent().then(function(e){return e.length<1?void d.runtime.callback(!1,{message:"no unspent transactions found"}):void a.filterUnspent({unspent:e,client:d.runtime.navClient,accountName:c.account[s.serverType]},d.unspentFiltered)}).catch(function(e){o.writeLog("RATS_002","failed to list unspent",e),d.runtime.callback(!1,{message:"failed to list unspent"})})},d.unspentFiltered=function(e,n){return!e||!n||!n.currentPending||n.currentPending.length<1?(o.writeLog("RATS_003","failed to filter unspent",n),void d.runtime.callback(!1,{message:"no current pending to return"})):(d.runtime.transactionsToReturn=n.currentPending,void d.returnToSender())},d.returnToSender=function(){return d.runtime.transactionsToReturn.constructor!==Array||d.runtime.transactionsToReturn.length<1?void d.runtime.callback(!0,{message:"all transactions returned to sender"}):void u.send({client:d.runtime.navClient,transaction:d.runtime.transactionsToReturn[0]},d.returnedToSender)},d.returnedToSender=function(e,n){e&&n&&n.rawOutcome||o.writeLog("RATS_004","unable to return to sender",{success:e,data:n}),d.runtime.transactionsToReturn.splice(0,1),d.returnToSender()},e.exports=d},function(e,n,t){"use strict";var r=t(12),i=t(13),s=t(15),o=t(20),a={runtime:{}};a.send=function(e,n){var t=["client","transaction"];return r.intersection(Object.keys(e),t).length!==t.length?(i.writeLog("RTS_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to ReturnAllToSenders.run"})):(a.runtime={},void e.client.getRawTransaction(e.transaction.txid).then(function(t){a.decodeOriginRaw({transaction:e.transaction,client:e.client,incomingRaw:t},n)}).catch(function(t){i.writeLog("RTS_002","unable to get raw transaction",{transaction:e.transaction,error:t}),n(!1,{message:"unable to get raw transaction"})}))},a.decodeOriginRaw=function(e,n){e.client.decodeRawTransaction(e.incomingRaw).then(function(t){a.getOriginRaw({transaction:e.transaction,client:e.client,incomingTrans:t},n)}).catch(function(t){i.writeLog("RTS_003","unable to decode raw transaction",{transaction:e.transaction,incomingRaw:e.incomingRaw,error:t}),n(!1,{message:"unable to decode raw transaction"})})},a.getOriginRaw=function(e,n){e.client.getRawTransaction(e.incomingTrans.vin[0].txid).then(function(t){a.decodeOriginInputRaw({transaction:e.transaction,client:e.client,incomingTrans:e.incomingTrans,inputRaw:t},n)}).catch(function(t){i.writeLog("RTS_004","unable to get the origins raw transaction",{transaction:e.transaction,incomingTrans:e.incomingTrans,error:t}),n(!1,{message:"unable to get the origins raw transaction"})})},a.decodeOriginInputRaw=function(e,n){e.client.decodeRawTransaction(e.inputRaw).then(function(t){var r=t.vout[e.incomingTrans.vin[0].vout].scriptPubKey.addresses[0];a.buildTransaction({transaction:e.transaction,client:e.client,origin:r},n)}).catch(function(t){i.writeLog("RTS_005","unable to decode raw incoming transaction",{transaction:e.transaction,inputRaw:e.inputRaw,error:t}),n(!1,{message:"unable to decode raw incoming transaction"})})},a.buildTransaction=function(e,n){var t={};t[e.origin]=e.transaction.amount-s.txFee;var r=[{txid:e.transaction.txid,vout:e.transaction.vout}];o.createRaw({outgoingTransactions:t,spentTransactions:r,client:e.client},n)},e.exports=a},function(e,n,t){"use strict";var r=t(12),i=t(7),s=i.get("GLOBAL"),o=t(13),a=t(17),c=t(15),u={};u.run=function(e,n){var t=["navClient","outgoingNavBalance","subBalance"];return r.intersection(Object.keys(e),t).length!==t.length?(o.writeLog("PREPI_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to ReturnAllToSenders.run"})):(u.runtime={callback:n,navClient:e.navClient,outgoingNavBalance:e.outgoingNavBalance,subBalance:e.subBalance},void u.getUnspent())},u.getUnspent=function(){u.runtime.navClient.listUnspent().then(function(e){return e.length<1?void u.runtime.callback(!1,{message:"no unspent transactions found"}):void a.filterUnspent({unspent:e,client:u.runtime.navClient,accountName:c.account[s.serverType]},u.unspentFiltered)}).catch(function(e){o.writeLog("PREPI_002","failed to list unspent",e),u.runtime.callback(!1,{message:"failed to list unspent"})})},u.unspentFiltered=function(e,n){return!e||!n||!n.currentPending||n.currentPending.length<1?(o.writeLog("PREPI_003","failed to filter unspent",n),void u.runtime.callback(!1,{message:"no current pending to return"})):(u.runtime.currentPending=n.currentPending,void u.pruneUnspent({currentPending:u.runtime.currentPending,client:u.runtime.navClient,subBalance:u.runtime.subBalance,maxAmount:u.runtime.outgoingNavBalance},u.unspentPruned))},u.pruneUnspent=function(e,n){if(!e.currentPending||!parseFloat(e.subBalance)||!parseFloat(e.maxAmount))return o.writeLog("NAV_006","pruneIncomingUnspent invalid params",{options:e}),void n(!1,{message:"invalid params"});var t=[],r=!1,i=0,s=!0,a=!1,u=void 0;try{for(var d,l=e.currentPending[Symbol.iterator]();!(s=(d=l.next()).done);s=!0){var g=d.value;(t.length+1)*(parseFloat(c.subCoinsPerTx)+parseFloat(c.subChainTxFee))<=e.subBalance&&i+g.amount<parseFloat(e.maxAmount)&&t.length<c.maxAddresses&&(i+=g.amount,r=!0,t.push(g))}}catch(e){a=!0,u=e}finally{try{!s&&l.return&&l.return()}finally{if(a)throw u}}r?n(!0,{currentBatch:t,sumPending:i}):n(!1,{message:"no pruned"})},u.unspentPruned=function(e,n){return!e||!n||!n.currentBatch||n.currentBatch.length<1?(o.writeLog("PREPI_003","failed to prune unspent",{success:e,data:n}),void u.runtime.callback(!1,{message:"failed to prune unspent"})):void u.runtime.callback(!0,{currentBatch:n.currentBatch})},e.exports=u},function(e,n,t){"use strict";var r=t(12),i=t(23),s=t(13),o=t(17),a={};a.run=function(e,n){var t=["subClient","chosenOutgoing","currentBatch"];return r.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("RSC_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to RetrieveSubchainAddresses.run"})):(a.runtime={callback:n,subClient:e.subClient,chosenOutgoing:e.chosenOutgoing,currentBatch:e.currentBatch},void a.getSubAddresses())},a.getSubAddresses=function(){var e=a.runtime.chosenOutgoing,n=e.port?e.ipAddress+":"+e.port:e.ipAddress;a.runtime.outgoingAddress=n;var t={uri:"https://"+n+"/api/get-addresses",method:"POST",timeout:6e4,rejectUnauthorized:!1,requestCert:!0,agent:!1,form:{type:"SUBCHAIN",account:"OUTGOING",num_addresses:a.runtime.currentBatch.length}};i(t,a.requestResponse)},a.requestResponse=function(e,n,t){return e?(s.writeLog("RSC_004","failed to query outgoing server",{error:e,outgoingAddress:a.runtime.outgoingAddress}),void a.runtime.callback(!1,{message:"failed to query outgoing server"})):void a.checkOutgoingCanTransact(t,a.runtime.outgoingAddress)},a.checkOutgoingCanTransact=function(e,n){try{var t=JSON.parse(e);if("SUCCESS"!==t.type)return s.writeLog("RSC_005","outgoing server returned failure",{body:t,outgoingAddress:n}),void a.runtime.callback(!1,{message:"outgoing server returned failure"});if(!t.data||!t.data.addresses||t.data.addresses.constructor!==Array)return s.writeLog("RSC_006","outgoing server returned incorrect params",{body:t,outgoingAddress:n}),void a.runtime.callback(!1,{message:"outgoing server returned failure"});a.checkSubAddresses(t.data.addresses)}catch(t){return s.writeLog("RSC_005A","outgoing server returned non json response",{body:e,error:t,outgoingAddress:n}),void a.runtime.callback(!1,{message:"outgoing server returned non json response"})}},a.checkSubAddresses=function(e){return e.length<1?(s.writeLog("RSC_007","outgoing server must provide at least one sub address",{subAddresses:e}),void a.runtime.callback(!1,{message:"outgoing server must provide at least one sub address"})):e.length<a.runtime.currentBatch.length?(s.writeLog("RSC_008","outgoing server did not provide enough sub addresses",{subAddressesLength:e.length,currentBatchLength:a.runtime.currentBatch.length}),void a.runtime.callback(!1,{message:"outgoing server did not provide enough sub addresses"})):(a.runtime.outgoingSubAddresses=e,void o.validateAddresses({client:a.runtime.subClient,addresses:e},a.subAddressesValid))},a.subAddressesValid=function(e){return e?void a.runtime.callback(!0,{subAddresses:a.runtime.outgoingSubAddresses}):(s.writeLog("RSC_009","invalid subchain addresses received",{subAddresses:a.runtime.outgoingSubAddresses}),void a.runtime.callback(!1,{message:"invalid subchain addresses received"}))},e.exports=a},function(e,n,t){"use strict";var r=t(12),i=t(11),s=t(13),o=t(19),a=t(15),c=t(29),u={};u.run=function(e,n){var t=["currentBatch","settings","subClient","outgoingPubKey","subAddresses","navClient"];return r.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("PROI_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to ProcessIncoming.run"})):(u.runtime={callback:n,currentBatch:e.currentBatch,settings:e.settings,subClient:e.subClient,navClient:e.navClient,outgoingPubKey:e.outgoingPubKey,subAddresses:e.subAddresses,transactionsToReturn:[],successfulSubTransactions:[]},u.runtime.remainingTransactions=e.currentBatch,void u.processPending())},u.processPending=function(){return u.runtime.remainingTransactions.length<1?void u.runtime.callback(!0,{successfulSubTransactions:u.runtime.successfulSubTransactions,transactionsToReturn:u.runtime.transactionsToReturn}):void o.getEncrypted({transaction:u.runtime.remainingTransactions[0],client:u.runtime.navClient},u.checkDecrypted)},u.transactionFailed=function(){u.runtime.transactionsToReturn.push(u.runtime.remainingTransactions[0]),u.runtime.remainingTransactions.splice(0,1),u.processPending()},u.checkDecrypted=function(e,n){return e&&n&&n.decrypted&&n.transaction?void u.runtime.navClient.validateAddress(n.decrypted).then(function(t){return t.isvalid!==!0?(s.writeLog("PROI_003","encrypted address invalid",{success:e,data:n}),void u.transactionFailed()):void u.reEncryptAddress(n.decrypted,n.transaction,0)}).catch(function(n){s.writeLog("PROI_004","failed to decrypt transaction data",{success:e,error:n}),u.transactionFailed()}):(s.writeLog("PROI_002","failed to decrypt transaction data",{success:e}),void u.transactionFailed())},u.reEncryptAddress=function(e,n,t){try{var r=n.amount-n.amount*u.runtime.settings.anonFeePercent/100,o={a:e,n:r,s:u.runtime.settings.secret},c=u.runtime.outgoingPubKey.encrypt(JSON.stringify(o),"utf8","base64",i.RSA_PKCS1_PADDING);if(c.length!==a.encryptionOutput.OUTGOING&&t<a.maxEncryptionAttempts)return s.writeLog("PROI_005","public key encryption failed",{transaction:n,counter:t,encrypted:c}),void(u.reEncryptAddress=t+1);if(c.length!==a.encryptionOutput.OUTGOING&&t>=a.maxEncryptionAttempts)return s.writeLog("PROI_006","max public key encryption failures",{transaction:n,counter:t,encrypted:c}),void u.transactionFailed();u.makeSubchainTx(c,n)}catch(e){return s.writeLog("PROI_007","encrypted address invalid",{transaction:n,error:e}),void u.transactionFailed()}},u.makeSubchainTx=function(e,n){c.send({client:u.runtime.subClient,address:u.runtime.subAddresses[0],amount:a.subCoinsPerTx,transaction:n,encrypted:e},u.sentSubToOutgoing)},u.sentSubToOutgoing=function(e,n){return e&&n&&n.sendOutcome?(u.runtime.successfulSubTransactions.push(n.transaction),u.runtime.subAddresses.splice(0,1),u.runtime.remainingTransactions.splice(0,1),void u.processPending()):(s.writeLog("PROI_008","failed subClient send to address",{transaction:n.transaction,error:n.error}),void u.transactionFailed())},e.exports=u},function(e,n,t){"use strict";var r=t(7),i=t(12),s=t(13),o=t(17),a=r.get("GLOBAL"),c=!1;"INCOMING"===a.serverType&&(c=r.get("INCOMING")),"OUTGOING"===a.serverType&&(c=r.get("OUTGOING"));var u={};u.send=function(e,n){var t=["client","address","amount","transaction"];return i.intersection(Object.keys(e),t).length!==t.length?(s.writeLog("STA_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to SelectOutgoing.run"})):(u.runtime={},e.counter&&e.counter>7?(s.writeLog("STA_002","max send attempts reached",{transaction:e.transaction,counter:e.counter}),void n(!1,{transaction:e.transaction,error:"max send attempts reached"})):void e.client.sendToAddress(e.address,parseFloat(e.amount),null,null,e.encrypted).then(function(t){if(t)return void n(!0,{sendOutcome:t,transaction:e.transaction})}).catch(function(t){if(t.code===-13&&!e.triedToUnlock){u.runtime.options=e,u.runtime.callback=n;var r=e.client.port===c.navCoin.port?"navCoin":"subChain";return void o.unlockWallet({settings:c,client:e.client,type:r},u.walletUnlocked)}s.writeLog("STA_003","failed send to address",{transaction:e.transaction,error:t}),setTimeout(function(){var t=e.counter?e.counter+1:1,r={client:e.client,address:e.address,amount:e.amount,transaction:e.transaction,encrypted:e.encrypted,counter:t,triedToUnlock:!1};u.send(r,n)},3e4)}))},u.walletUnlocked=function(e,n){if(!e)return s.writeLog("STA_004","unable to unlock wallet",{success:e,data:n}),void u.runtime.callback(!1,{transaction:u.runtime.options.transaction,error:n});var t={client:u.runtime.options.client,address:u.runtime.options.address,amount:u.runtime.options.amount,transaction:u.runtime.options.transaction,encrypted:u.runtime.options.encrypted,counter:u.runtime.options.counter,triedToUnlock:!0};u.send(t,u.runtime.callback)},e.exports=u},function(e,n,t){"use strict";var r=t(12),i=t(13),s=t(21),o=t(15),a=t(20),c={};c.run=function(e,n){var t=["successfulSubTransactions","holdingEncrypted","navClient"];return r.intersection(Object.keys(e),t).length!==t.length?(i.writeLog("STH_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to SpendToHolding.run"})):(c.runtime={callback:n,successfulSubTransactions:e.successfulSubTransactions,holdingEncrypted:e.holdingEncrypted,navClient:e.navClient},void s.getRandomAccountAddresses({client:c.runtime.navClient,accountName:o.account.HOLDING,numAddresses:1},c.createHoldingTransactions))},c.createHoldingTransactions=function(e,n){if(!e)return i.writeLog("STH_002","could not retrieve holding addresses",{success:e,data:n}),void c.runtime.callback(!1,{message:"could not retrieve holding addresses"});var t=0,r=!0,s=!1,u=void 0;try{for(var d,l=c.runtime.successfulSubTransactions[Symbol.iterator]();!(r=(d=l.next()).done);r=!0){var g=d.value;t+=g.amount-o.txFee}}catch(e){s=!0,u=e}finally{try{!r&&l.return&&l.return()}finally{if(s)throw u}}for(var p=[],v=0;v<c.runtime.successfulSubTransactions.length;v++)p.push({txid:c.runtime.successfulSubTransactions[v].txid,vout:parseInt(c.runtime.successfulSubTransactions[v].vout,10)});var m={};m[n.pickedAddresses[0]]=t,a.createRaw({outgoingTransactions:m,spentTransactions:p,client:c.runtime.navClient,encrypted:c.runtime.holdingEncrypted},c.sentToHolding)},c.sentToHolding=function(e,n){return e?void c.runtime.callback(!0,n):(i.writeLog("STH_003","could not send raw transaction to holding",{success:e,data:n}),void c.runtime.callback(!1,{message:"could not send raw transaction to holding"}))},e.exports=c},function(e,n,t){"use strict";var r=t(1),i=t(13),s=t(10),o=t(16),a=t(32),c=t(33),u=t(34),d=t(35),l=t(7),g=l.get("OUTGOING"),p={processing:!1,paused:!1,runtime:{}};p.init=function(){p.navClient=new r({username:g.navCoin.user,password:g.navCoin.pass,port:g.navCoin.port,host:g.navCoin.host}),p.subClient=new r({username:g.subChain.user,password:g.subChain.pass,port:g.subChain.port,host:g.subChain.host}),i.writeLog("OUT_000","server starting"),s.findKeysToRemove({type:"private"},p.startProcessing),setInterval(function(){p.paused===!1?s.findKeysToRemove({type:"private"},p.startProcessing):i.writeLog("OUT_001","processing paused",{paused:p.paused})},g.scriptInterval)},p.startProcessing=function(){return p.processing?void i.writeLog("OUT_002","server still processing",{processing:p.processing}):(p.processing=!0,p.runtime={},p.runtime.cycleStart=new Date,void o.run({navClient:p.navClient,subClient:p.subClient,settings:g},p.preFlightComplete))},p.preFlightComplete=function(e,n){return e?(p.runtime.navBalance=n.navBalance,p.runtime.subBalance=n.subBalance,void a.run({navClient:p.navClient,subClient:p.subClient,navBalance:n.navBalance,settings:g},p.currentBatchPrepared)):(i.writeLog("OUT_003","preflight checks failed",{success:e,data:n},!0),void(p.processing=!1))},p.currentBatchPrepared=function(e,n){return e?(p.runtime.failedSubTransactions=n.failedSubTransactions,p.runtime.currentBatch=n.currentBatch,void c.run({currentBatch:p.runtime.currentBatch,navClient:p.navClient,settings:g},p.transactionsProcessed)):void(p.processing=!1)},p.transactionsProcessed=function(e,n){return e&&n?!n.successfulTransactions||n.successfulTransactions.length<1?(i.writeLog("OUT_005","all transactions failed",n,!0),p.processing=!1,void(p.paused=!0)):(p.runtime.successfulTransactions=n.successfulTransactions,void u.run({navClient:p.navClient,settings:g},p.feePaid)):(i.writeLog("OUT_004","failed to process transactions",{success:e,data:n},!0),p.processing=!1,void(p.paused=!0))},p.feePaid=function(e,n){e||i.writeLog("OUT_006","failed nav send to txfee address",{transaction:n.transaction,error:n.error},!0),d.run({transactions:p.runtime.successfulTransactions,subClient:p.subClient,settings:g},p.subnavReturned)},p.subnavReturned=function(e){return e?void(p.processing=!1):(i.writeLog("OUT_007","unable to return subnav to incoming server",{transactions:p.runtime.successfulTransactions},!0),p.paused=!0,void(p.processing=!1))},e.exports=p},function(e,n,t){"use strict";var r=t(12),i=t(7),s=i.get("GLOBAL"),o=t(13),a=t(17),c=t(19),u=t(15),d={};d.run=function(e,n){var t=["navClient","subClient","navBalance","settings"];return r.intersection(Object.keys(e),t).length!==t.length?(o.writeLog("PREPO_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to ReturnAllToSenders.run"})):(d.runtime={callback:n,navClient:e.navClient,subClient:e.subClient,navBalance:e.navBalance,settings:e.settings,failedSubTransactions:[],currentBatch:[],sumPending:0},void d.getUnspent())},d.getUnspent=function(){d.runtime.subClient.listUnspent().then(function(e){return e.length<1?void d.runtime.callback(!1,{message:"no unspent transactions found"}):void a.filterUnspent({unspent:e,client:d.runtime.subClient,accountName:u.account[s.serverType]},d.unspentFiltered)}).catch(function(e){o.writeLog("PREPO_002","failed to list unspent",e),d.runtime.callback(!1,{message:"failed to list unspent"})})},d.unspentFiltered=function(e,n){return!e||!n||!n.currentPending||n.currentPending.length<1?(o.writeLog("PREPO_003","no current pending to return",n),void d.runtime.callback(!1,{message:"no current pending to return"})):(d.runtime.currentPending=n.currentPending,void d.processTransaction())},d.processTransaction=function(){return d.runtime.currentPending.length<1?void d.runtime.callback(!0,{failedSubTransactions:d.runtime.failedSubTransactions,currentBatch:d.runtime.currentBatch}):void c.getEncrypted({transaction:d.runtime.currentPending[0],client:d.runtime.subClient},d.checkDecrypted)},d.failedTransaction=function(){d.runtime.failedSubTransactions.push(d.runtime.currentPending[0]),d.runtime.currentPending.splice(0,1),d.processTransaction()},d.checkDecrypted=function(e,n){return e&&n&&n.decrypted&&n.transaction?n.decrypted.a&&n.decrypted.n&&n.decrypted.s?parseFloat(n.decrypted.n)>d.runtime.settings.maxAmount?(o.writeLog("PREPO_006","decrypted amount is larger than maxAmount",{success:e}),void d.failedTransaction()):(n.decrypted.s!==d.runtime.settings.secret&&(o.writeLog("PREPO_007","secret mismatch",{success:e}),d.failedTransaction()),void d.testDecrypted(n.decrypted,n.transaction)):(o.writeLog("PREPO_005","transaction has invalid params",{success:e}),void d.failedTransaction()):(o.writeLog("PREPO_004","failed to decrypt transaction",{success:e}),void d.failedTransaction())},d.testDecrypted=function(e,n){d.runtime.navClient.validateAddress(e.a).then(function(t){return t.isvalid!==!0?(o.writeLog("PREPO_008","recipient address is invalid",{transaction:n}),void d.failedTransaction()):d.runtime.navBalance>d.runtime.sumPending+parseFloat(e.n)?(d.runtime.sumPending=d.runtime.sumPending+parseFloat(e.n),d.runtime.currentBatch.push({decrypted:e,transaction:n}),d.runtime.currentPending.splice(0,1),void d.processTransaction()):void d.runtime.callback(!0,{failedSubTransactions:d.runtime.failedSubTransactions,currentBatch:d.runtime.currentBatch})}).catch(function(t){o.writeLog("PREPO_009","navClient failed validate address",{decrypted:e,transaction:n,error:t}),d.failedTransaction();
})},e.exports=d},function(e,n,t){"use strict";var r=t(12),i=t(13),s=t(21),o=t(29),a={};a.run=function(e,n){var t=["currentBatch","settings","navClient"];return r.intersection(Object.keys(e),t).length!==t.length?(i.writeLog("PROO_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to ProcessOutgoing.run"})):(a.runtime={callback:n,currentBatch:e.currentBatch,settings:e.settings,navClient:e.navClient,successfulTransactions:[],failedTransactions:[]},a.runtime.remainingTransactions=e.currentBatch,void a.processPending())},a.processPending=function(){return a.runtime.remainingTransactions.length<1?void a.runtime.callback(!0,{successfulTransactions:a.runtime.successfulTransactions,failedTransactions:a.runtime.failedTransactions}):(a.runtime.partialTransactions=[],void s.outgoing({transaction:a.runtime.remainingTransactions[0],amount:a.runtime.remainingTransactions[0].decrypted.n,address:a.runtime.remainingTransactions[0].decrypted.a},a.amountsRandomized))},a.transactionFailed=function(){a.runtime.failedTransactions.push(a.runtime.remainingTransactions[0]),a.runtime.remainingTransactions.splice(0,1),a.processPending()},a.amountsRandomized=function(e,n){return e&&n?(a.runtime.partialTransactions=n.partialTransactions,void a.createNavTransactions()):(i.writeLog("PROO_002","failed to randomize transaction",{success:e,data:n},!0),void a.transactionFailed())},a.mockSend=function(){i.writeLog("PROO_003A","mock nav sent",{transaction:a.runtime.remainingTransactions[0]}),a.runtime.successfulTransactions.push({transaction:a.runtime.remainingTransactions[0].transaction}),a.runtime.remainingTransactions.splice(0,1),a.processPending()},a.createNavTransactions=function(){return a.runtime.partialTransactions.length<1?(i.writeLog("PROO_003","all partial nav sent",{transaction:a.runtime.remainingTransactions[0].transaction}),a.runtime.successfulTransactions.push({transaction:a.runtime.remainingTransactions[0].transaction}),a.runtime.remainingTransactions.splice(0,1),void a.processPending()):void o.send({client:a.runtime.navClient,address:a.runtime.remainingTransactions[0].decrypted.a,amount:a.runtime.partialTransactions[0],transaction:a.runtime.remainingTransactions[0]},a.sentPartialNav)},a.sentPartialNav=function(e,n){return e&&n&&n.sendOutcome?(a.runtime.partialTransactions.splice(0,1),void a.createNavTransactions()):(i.writeLog("PROO_004","failed nav send to address",n,!0),void a.runtime.callback(!1,{message:"failed sending partial transaction to address",failedTransaction:a.runtime.remainingTransactions[0],remainingPartials:a.runtime.partialTransactions}))},e.exports=a},function(e,n,t){"use strict";var r=t(12),i=t(13),s=t(29),o=t(15),a={};a.run=function(e,n){var t=["settings","navClient"];return r.intersection(Object.keys(e),t).length!==t.length?(i.writeLog("PAY_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to PayoutFee.run"})):(a.runtime={callback:n,settings:e.settings,navClient:e.navClient},void a.send())},a.send=function(){a.runtime.navClient.getBalance().then(function(e){if(e<a.runtime.settings.navPoolAmount)return i.writeLog("PAY_002","nav pool balance less than expected",{navPoolAmount:a.runtime.settings.navPoolAmount,navBalance:e}),void a.runtime.callback(!1,{message:"nav pool balance less than expected"});var n=e-a.runtime.settings.navPoolAmount-o.txFee;return n<a.runtime.settings.txFeePayoutMin?void a.runtime.callback(!1,{message:"fee accrued less than payout minimum"}):void s.send({client:a.runtime.navClient,address:a.runtime.settings.anonTxFeeAddress,amount:n},a.sent)})},a.sent=function(e,n){return e?void a.runtime.callback(!0,n):void a.runtime.callback(!1,{message:"failed to send fee payout"})},e.exports=a},function(e,n,t){"use strict";var r=t(12),i=t(13),s=t(25),o={};o.run=function(e,n){var t=["settings","subClient","transactions"];return r.intersection(Object.keys(e),t).length!==t.length?(i.writeLog("RSN_001","invalid options",{options:e,required:t}),void n(!1,{message:"invalid options provided to ReturnSubnav.run"})):(o.runtime={callback:n,settings:e.settings,subClient:e.subClient,transactions:e.transactions},o.runtime.remainingTransactions=e.transactions,void o.sendToIncoming())},o.sendToIncoming=function(){return o.runtime.remainingTransactions.constructor!==Array||o.runtime.remainingTransactions.length<1?void o.runtime.callback(!0,{message:"all subnav returned to incoming server"}):void s.send({client:o.runtime.subClient,transaction:o.runtime.remainingTransactions[0].transaction},o.sent)},o.sent=function(e,n){return e&&n&&n.rawOutcome?(o.runtime.remainingTransactions.splice(0,1),void o.sendToIncoming()):(i.writeLog("RSN_002","unable to return subnav to incoming server",{remaining:o.runtime.remainingTransactions,success:e,data:n},!0),void o.runtime.callback(!1,{message:"failed to return subnav"}))},e.exports=o},function(e,n,t){"use strict";function r(e,n,t,s){if("object"===("undefined"==typeof e?"undefined":v(e))&&"remote"!==s)for(var o in t)t.hasOwnProperty(o)&&r(e[o],n,t[o],o);else if("remote"===s)for(var a=0;a<e.length;a++)for(var c in t)t.hasOwnProperty(c)&&r(e[a][c],n,t[c],c);else i(e,n,t,s)}function i(e,n,t,r){if(t.required===!0&&!e)return void C.errors.push("VALUE_IS_REQUIRED for "+r,e);if(t.required!==!1||e&&void 0!==e){if("object"===v(t.required)&&t.required.conditional){var i=t.required.conditional.split(".");if("GLOBAL"===i[0]){var m=h[i[1]];if(!m)return}}if(!e||void 0===e)return void C.errors.push("MISSING_VALUE for "+r+", must provide a valid value");if(!n||n.indexOf(r)===-1)switch("remote"===r&&console.log(r,e),t.type){case"DOMAIN":s(e,t,r);break;case"IP_ADDRESS":o(e,t,r);break;case"PORT":a(e,t,r);break;case"INT":c(e,t,r);break;case"FLOAT":u(e,t,r);break;case"EMAIL":d(e,t,r);break;case"NAV_ADDRESS":l(e,t,r);break;case"STRING":g(e,t,r);break;case"VALUE":p(e,t,r);break;default:C.errors.push("NO_VALIDATION_SET for "+r)}}}function s(e,n,t){return!!f.isFQDN(e)||(C.errors.push("INVALID_DOMAIN for "+t+", must be a valid fully qualified domain name"),!1)}function o(e,n,t){return!!f.isIP(e)||(C.errors.push("INVALID_IP_ADDRESS for "+t+", must be a valid IP Address"),!0)}function a(e,n,t){var r=parseInt(e,10);return(r<1||r>65535)&&(C.errors.push("PORT_OUT_OF_RANGE for "+t+", must be between 1 and 65535 "),!0)}function c(e,n,t){var r=parseInt(e,10);return n.min&&r<n.min?(C.errors.push("INT_TOO_SMALL for "+t+", must be bigger than "+n.min),!1):!(n.max&&r>n.max)||(C.errors.push("INT_TOO_LARGE for "+t+", must be smaller than "+n.max),!1)}function u(e,n,t){var r=parseFloat(e);if(n.min&&r<n.min)return C.errors.push("FLOAT_TOO_SMALL for "+t+", must be bigger than "+n.min),!1;if(n.max&&r>n.max)return C.errors.push("FLOAT_TOO_LARGE for "+t+", must be smaller than "+n.max),!1;if(n.decimals&&2===n.decimals){var i=e.toString().search(A)>=0;if(!i)return C.errors.push("FLOAT_INCORRECT_FORMAT for "+t+", must have a maximum of 2 decimal places "),!1}return!0}function d(e,n,t){return!!f.isEmail(e)||(C.errors.push("INVALID_DOMAIN for "+t+", must be a valid fully qualified domain name"),!1)}function l(e,n,t){return 34===e.length||"N"===e.charAt(0)||(C.errors.push("INVALID_NAV_ADDRESSS for "+t+", must be 34 characters and starting with N"),!1)}function g(e,n,t){return!n.length||e.length===n.length||(C.errors.push("INCORRECT_LENGTH for "+t+", must be "+n.length+" characters"+e.length+" provided"),!1)}function p(e,n,t){return e===n.value||(C.errors.push("INCORRECT_VALUE for "+t+", must equal "+n.value),!1)}var v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m=t(7),f=t(37),y=t(13),h=m.get("GLOBAL"),b=t(38),T=t(39),A=/^(\d+)?([.]?\d{0,2})?$/,C={errors:[]};C.validateSettings=function(e,n){if(C.errors=[],"INCOMING"===h.serverType)r(e.settings,e.ignore,b);else{if("OUTGOING"!==h.serverType)return y.writeLog("VAL_001","invalid server type",{options:e}),void n(!1);r(e.settings,e.ignore,T)}C.errors.length<1?n(!0):(y.writeLog("VAL_002","invalid settings",{errors:C.errors}),n(!1))},e.exports=C},function(e,n){e.exports=require("validator")},function(e,n){e.exports={local:{ipAddress:{required:!0,type:"IP_ADDRESS"},port:{required:!0,type:"PORT"}},remote:{host:{required:!1,type:"DOMAIN"},ipAddress:{required:!0,type:"IP_ADDRESS"},port:{required:!0,type:"PORT"}},scriptInterval:{required:!0,type:"INT",min:3e4},minAmount:{required:!0,type:"INT",min:10},maxAmount:{required:!0,type:"INT",min:10},anonFeePercent:{required:!0,type:"FLOAT",min:0,max:99,decimals:2},notificationEmail:{required:!0,type:"EMAIL"},smtp:{user:{required:!0,type:"EMAIL"},pass:{required:!0,type:"STRING"},server:{required:!0,type:"DOMAIN"}},navCoin:{user:{required:!0,type:"STRING"},pass:{required:!0,type:"STRING"},ip:{required:!0,type:"IP_ADDRESS"},port:{required:!0,type:"VALUE",value:"44444"},walletPassphrase:{required:{conditional:"GLOBAL.encryptedWallet"},type:"STRING"}},subChain:{user:{required:!0,type:"STRING"},pass:{required:!0,type:"STRING"},ip:{required:!0,type:"IP_ADDRESS"},port:{required:!0,type:"VALUE",value:"33333"},walletPassphrase:{required:{conditional:"GLOBAL.encryptedWallet"},type:"STRING"}},secretOptions:{salt:{required:!0,type:"STRING",length:32},saltRounds:{required:!0,type:"INT",min:1,max:20}},secret:{required:!0,type:"STRING",length:42}}},function(e,n){e.exports={local:{ipAddress:{required:!0,type:"IP_ADDRESS"},port:{required:!0,type:"PORT"}},remote:{host:{required:!1,type:"DOMAIN"},ipAddress:{required:!0,type:"IP_ADDRESS"},port:{required:!0,type:"PORT"}},scriptInterval:{required:!0,type:"INT",min:12e4},minAmount:{required:!0,type:"INT",min:10},maxAmount:{required:!0,type:"INT",min:10},navPoolAmount:{required:!0,type:"INT",min:5e4},txFeePayoutMin:{required:!0,type:"INT",min:1},anonTxFeeAddress:{required:!0,type:"NAV_ADDRESS"},notificationEmail:{required:!0,type:"EMAIL"},smtp:{user:{required:!0,type:"EMAIL"},pass:{required:!0,type:"STRING"},server:{required:!0,type:"DOMAIN"}},navCoin:{user:{required:!0,type:"STRING"},pass:{required:!0,type:"STRING"},ip:{required:!0,type:"IP_ADDRESS"},port:{required:!0,type:"VALUE",value:"44444"},walletPassphrase:{required:{conditional:"GLOBAL.encryptedWallet"},type:"STRING"}},subChain:{user:{required:!0,type:"STRING"},pass:{required:!0,type:"STRING"},ip:{required:!0,type:"IP_ADDRESS"},port:{required:!0,type:"VALUE",value:"33333"},walletPassphrase:{required:{conditional:"GLOBAL.encryptedWallet"},type:"STRING"}},secret:{required:!0,type:"STRING",length:42}}}]);